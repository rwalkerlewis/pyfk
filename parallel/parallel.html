
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Parallelization &#8212; PyFK 0.2.0 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Benchmark" href="../benchmark/benchmark.html" />
    <link rel="prev" title="Tutorial" href="../introduction/tutorial.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    
<a class="navbar-brand" href="../index.html">
<p class="title">PyFK</p>
</a>

    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../introduction/install.html">
  Installing
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../introduction/tutorial.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="current reference internal nav-link" href="#">
  Parallelization
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../benchmark/benchmark.html">
  Benchmark
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../gallery/gallery.html">
  Gallery
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../autoapi/index.html">
  API Reference
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mpi-mode">
   MPI Mode
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gpu-mode">
   GPU mode
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#usage-tips">
     Usage tips
    </a>
   </li>
  </ul>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <section id="parallelization">
<span id="parallel"></span><h1>Parallelization<a class="headerlink" href="#parallelization" title="Permalink to this headline">#</a></h1>
<p>Why are we using <code class="docutils literal notranslate"><span class="pre">PyFK</span></code>? You may think it’s more pythonic and can tolerant the possible inefficiency. However, with the parallelization, it can be much faster than you may think.</p>
<p>The idea to parallelize the FK algorithm is simple, based on <a class="reference external" href="https://blog.seisman.info/fk-notes/">The introduction from Seisman (In Chinese)</a>, we know the simulate consists of two levels of the loop, one is for the frequency, and another is for the wavenumber. So these two loops can be flattened to one large loop and apply parallelism.</p>
<p>The parallelization is designed only to calculate the Green’s function as it’s the most time-consuming part. The calculation of the synthetic waveforms is only about convolving the source, which is much faster.</p>
<section id="mpi-mode">
<h2>MPI Mode<a class="headerlink" href="#mpi-mode" title="Permalink to this headline">#</a></h2>
<p>To use the MPI mode, you have to compile from the source with the environment <code class="docutils literal notranslate"><span class="pre">PYFK_USE_MPI</span></code> set as 1. The reason for this design is that the MPI mode relies on <code class="docutils literal notranslate"><span class="pre">mpi4py</span></code>, which has the dependency of the system-provided MPI package. Everything should be compiled in the local machine, not to mention we are using MPI inside Cython.</p>
<p>After successfully installing <code class="docutils literal notranslate"><span class="pre">PyFK</span></code> with the MPI support. You can directly use it to perform the simulation. Assume we have a Python script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">obspy</span>
<span class="kn">from</span> <span class="nn">pyfk.config.config</span> <span class="kn">import</span> <span class="n">Config</span><span class="p">,</span> <span class="n">SeisModel</span><span class="p">,</span> <span class="n">SourceModel</span>
<span class="kn">from</span> <span class="nn">pyfk.gf.gf</span> <span class="kn">import</span> <span class="n">calculate_gf</span>
<span class="kn">from</span> <span class="nn">pyfk.tests.taup.test_taup</span> <span class="kn">import</span> <span class="n">TestFunctionTaup</span>

<span class="n">model_data</span> <span class="o">=</span> <span class="n">SeisModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">TestFunctionTaup</span><span class="o">.</span><span class="n">gen_test_model</span><span class="p">(</span><span class="s2">&quot;prem&quot;</span><span class="p">))</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">SourceModel</span><span class="p">(</span><span class="n">sdep</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
    <span class="n">npt</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">receiver_distance</span><span class="o">=</span><span class="p">[</span>
        <span class="mi">10</span><span class="p">,</span>
        <span class="mi">20</span><span class="p">,</span>
        <span class="mi">30</span><span class="p">])</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">calculate_gf</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p>This script loads the PREM model and calculates Green’s function based on our setting. It is the same as the serial mode, but when <code class="docutils literal notranslate"><span class="pre">calculate_gf</span></code> detects it’s called by <code class="docutils literal notranslate"><span class="pre">mpirun</span></code>, it will automatically be run with MPI. The calculated Green’s function is broadcasted to all the processes, and can be further processed by only considering the main process such as setting <code class="docutils literal notranslate"><span class="pre">rank==0</span></code>. I will not talk about this part which should be introduced in <a class="reference external" href="https://mpi4py.readthedocs.io/en/stable/">The document of mpi4py</a>.</p>
</section>
<section id="gpu-mode">
<h2>GPU mode<a class="headerlink" href="#gpu-mode" title="Permalink to this headline">#</a></h2>
<p>The GPU mode can be enabled by passing <code class="docutils literal notranslate"><span class="pre">cuda=True</span></code> in <code class="docutils literal notranslate"><span class="pre">Config</span></code>, or set the system environment <code class="docutils literal notranslate"><span class="pre">PYFK_USE_CUDA</span></code> as 1. <code class="docutils literal notranslate"><span class="pre">PYFK_USE_CUDA</span></code> will only be read during the calculation, which has no relationship with the package installation part. Either <code class="docutils literal notranslate"><span class="pre">cuda=True</span></code> or <code class="docutils literal notranslate"><span class="pre">PYFK_USE_CUDA</span></code> will enable the GPU mode.</p>
<p>To enable the GPU mode, additional packages are required, including Numba and CuPy. Note these packages are not automatically installed by <code class="docutils literal notranslate"><span class="pre">pip</span></code> or <code class="docutils literal notranslate"><span class="pre">conda</span></code> to avoid the unnecessary package dependencies. Numba is used to compile the CUDA kernel, while CuPy provides additional functions to calculate the special functions on GPU, which is used in this package.</p>
<p>For future versions, these dependencies might be removed by directly using CUDA.</p>
<p>For consistency, you don’t have to make any additional modifications to the existing code. As long as the GPU mode is enabled, the calculation of Green’s function will be automatically on GPU. It’s suggested to perform benchmark before migrating to GPU, as smaller jobs might not be worthy.</p>
<p>There might have a problem that the GPU memory is not big enough. It’s possible as we first generate all the information before performing the two-loop integration, then move all the info to GPU. A workaround to this problem is to divide the large memory information into small subsets; after one subset has finished calculation, we move another one. <code class="docutils literal notranslate"><span class="pre">PyFK</span></code> has provided a system environment variable named <code class="docutils literal notranslate"><span class="pre">CUDA_DIVIDE_NUM</span></code>. If this environment has not been set, its value will be one, which means there will only be one subset. Try to make this value larger when there is not enough GPU memory.</p>
<p>The bottleneck of the GPU calculation is the data moving. Currently, there is no better way to solve this problem; using thread is not the way to go as the actual calculation on GPU is pretty fast. So it’s not surprising if you look at the system monitor, and the GPU efficiency is only 0%, although we know it’s running on GPU and it’s fast. Look at the GPU memory usage, and you will get that we are using GPU.</p>
<section id="usage-tips">
<h3>Usage tips<a class="headerlink" href="#usage-tips" title="Permalink to this headline">#</a></h3>
<p>There is also the possibility that the cluster has multiple GPUs installed, try to use <code class="docutils literal notranslate"><span class="pre">nvidia-smi</span></code> to find the free GPU that doesn’t have much memory allocated, and at the start of your simulation script, put:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">cuda</span>
<span class="c1"># select the second GPU for example (start from 0)</span>
<span class="n">cuda</span><span class="o">.</span><span class="n">select_device</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>It will use the second GPU instead of the first one.</p>
<p>Since PyFK uses numba to compile CUDA kernel with JIT, it also might be slower when running the code for the first time. Please be aware of that when performing the benchmark.</p>
</section>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../introduction/tutorial.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Tutorial</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../benchmark/benchmark.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Benchmark</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2020-2022, Ziyi Xi.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>